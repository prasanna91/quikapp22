---
description:
globs:
alwaysApply: false
---
rule: Use App Store Connect API for iOS workflow validation
when:
  - file: codemagic.yaml
    contains: "app_store_connect"
    message: |
      Modern iOS workflows should use the App Store Connect API for validation and deployment.
      Please ensure your workflow uses the `app_store_connect` block with `api_key` credentials as recommended by Apple.
      Example:
        publishing:
          app_store_connect:
            api_key:
              key_id: $APP_STORE_CONNECT_KEY_ID
              issuer_id: $APP_STORE_CONNECT_ISSUER_ID
              private_key: $APP_STORE_CONNECT_PRIVATE_KEY
            submit_to_testflight: true
            submit_to_app_store: false
      See: https://docs.codemagic.io/publishing-yaml/distribution/#publishing-to-app-store-connect-using-api-key
severity: error
requirement: |
  To use the App Store Connect API for code signing, exporting IPA, and uploading to TestFlight, ensure the following:
    - You have generated an App Store Connect API key with the necessary permissions (Access to Certificates, Identifiers & Profiles, and App Manager).
    - The API key, key ID, and issuer ID are securely stored (e.g., as environment variables or in Codemagic's encrypted variables).
    - Your workflow includes the `app_store_connect` block with the `api_key` credentials.
    - Xcode project is properly configured for automatic code signing.

usage: |
  Example Codemagic YAML configuration for iOS workflows using App Store Connect API:

    publishing:
      app_store_connect:
        api_key:
          key_id: $APP_STORE_CONNECT_KEY_ID
          issuer_id: $APP_STORE_CONNECT_ISSUER_ID
          private_key: $APP_STORE_CONNECT_PRIVATE_KEY
        submit_to_testflight: true
        submit_to_app_store: false

  This configuration will:
    - Use the App Store Connect API for code signing and exporting the IPA.
    - Upload the generated IPA to TestFlight automatically.

  For more details, see: https://docs.codemagic.io/publishing-yaml/distribution/#publishing-to-app-store-connect-using-api-key
  # Rule: Centralize iOS Workflow Scripts

  description: |
    All scripts required for the iOS workflow must be located under the `lib/scripts/ios-workflow` directory.
    This ensures maintainability, discoverability, and consistency across iOS build and deployment processes.

  requirement: |
    - All shell, Python, or utility scripts invoked by the iOS workflow (e.g., build, code signing, certificate handling, email notifications, environment setup, validation, etc.) must be present in `lib/scripts/ios-workflow/`.
    - If scripts currently exist elsewhere (e.g., `lib/scripts/ios/` or `lib/scripts/utils/`), copy or refactor them into `lib/scripts/ios-workflow/`.
    - Update all workflow references (in YAML, shell scripts, or CI/CD configs) to use the new path.
    - Remove or deprecate the old script locations after migration.

  usage: |
    Example migration steps:
      1. Move or copy all required scripts to `lib/scripts/ios-workflow/`.
         For example:
           mv lib/scripts/ios/main.sh lib/scripts/ios-workflow/main.sh
           mv lib/scripts/ios/email_notifications.sh lib/scripts/ios-workflow/email_notifications.sh
           mv lib/scripts/utils/send_email.py lib/scripts/ios-workflow/send_email.py
      2. Update all references in your workflow files:
           - codemagic.yaml
           - Any shell scripts that call these scripts
           - Documentation
      3. Test the workflow to ensure all scripts are correctly referenced and functional.
      4. Remove the old script files from their previous locations to avoid confusion.

    Benefits:
      - All iOS workflow scripts are organized in a single directory.
      - Easier onboarding for new developers and maintainers.
      - Reduces risk of missing or outdated scripts during workflow changes.

  severity: warning

  message: |
    All scripts required for the iOS workflow should be present under `lib/scripts/ios-workflow/`.
    Please move, copy, or recreate any necessary scripts into this directory and update all references accordingly.
    // ⚠️ Do NOT hardcode workflow variables for ios-workflow!
    //
    // Codemagic automatically injects all required variables (such as APP_NAME, VERSION_NAME, EMAIL_ID, BUNDLE_ID, APPLE_TEAM_ID, PROFILE_TYPE, API keys, etc.)
    // into the workflow environment at runtime.
    //
    // Best Practices:
    // - Always reference variables using environment variable syntax (e.g., $APP_NAME, $EMAIL_ID, $BUNDLE_ID) in your scripts and YAML.
    // - Do NOT copy-paste or hardcode values for these variables in scripts, YAML, or code.
    // - If you need to use a variable in a shell script, use: "$VARIABLE_NAME" (e.g., "$APP_NAME")
    // - If you need to use a variable in Python, use: os.environ.get("VARIABLE_NAME")
    //
    // Example (shell):
    //   echo "Building $APP_NAME version $VERSION_NAME for bundle $BUNDLE_ID"
    //
    // Example (Python):
    //   import os
    //   app_name = os.environ.get("APP_NAME")
    //
    // This ensures your workflow is portable, secure, and always uses the latest values provided by Codemagic.
    //
    // If you need a full list of available variables, refer to the Codemagic documentation or print the environment in your workflow:
    //   - In shell: env | sort
    //   - In Python: import os; print(dict(os.environ))
